<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Para Ti ❤️ Con Amor Infinito</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Three.js (3D Library) -->
  <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"
      }
    }
  </script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Poppins', sans-serif; }
    .font-title { font-family: 'Dancing+Script', cursive; }
    #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .backdrop-blur-lg { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.8s ease-out forwards; }
    
    .custom-scrollbar::-webkit-scrollbar { width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 105, 180, 0.6); border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 105, 180, 0.8); }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(96, 165, 250, 0.6); }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(96, 165, 250, 0.8); }

    /* Efecto de brillo para el título */
    .text-glow {
      text-shadow: 0 0 8px rgba(255, 105, 180, 0.6), 
                   0 0 20px rgba(255, 105, 180, 0.4), 
                   0 0 40px rgba(255, 105, 180, 0.2);
      transition: text-shadow 0.5s ease;
    }
    body.dark-theme .text-glow {
       text-shadow: 0 0 8px rgba(96, 165, 250, 0.6),
                    0 0 20px rgba(96, 165, 250, 0.4),
                    0 0 40px rgba(96, 165, 250, 0.2);
    }

    /* Chat bubble animations */
    @keyframes bubbleIn {
        from { opacity: 0; transform: scale(0.8) translateY(10px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .chat-bubble {
        animation: bubbleIn 0.3s ease-out forwards;
    }
    
    /* Animación del personaje ASCII */
    @keyframes heartBeat {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.3); }
    }
    .heart-char {
        display: inline-block;
        animation: heartBeat 1.5s ease-in-out infinite;
    }

    /* Animación de explosión de corazones */
    #confetti-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
    }
    .confetti-heart {
        position: absolute;
        color: red;
        font-size: 24px;
        animation: explode 1.5s ease-out forwards;
        opacity: 0;
    }
    @keyframes explode {
        0% { transform: translate(50%, 50%) scale(0); opacity: 1; }
        100% { transform: translate(var(--x), var(--y)) scale(1); opacity: 0; }
    }

  </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden transition-colors duration-500">

  <!-- Elemento de Audio para la música de fondo -->
  <audio id="bg-music" loop>
    <source src="https://cdn.pixabay.com/audio/2022/02/14/audio_29c32a8832.mp3" type="audio/mpeg">
    Tu navegador no soporta audio.
  </audio>

  <canvas id="bg-canvas"></canvas>

  <main id="main-content" class="relative min-h-screen flex flex-col items-center justify-center p-4 transition-opacity duration-1000">
    <div class="text-center z-10 p-6 max-w-2xl w-full">
      <h1 class="font-title text-glow text-6xl md:text-8xl text-pink-300 drop-shadow-lg fade-in" style="animation-delay: 200ms;">Jirafa y Pinguina</h1>
      <p class="mt-4 text-lg md:text-xl text-gray-300 fade-in" style="animation-delay: 400ms;">Una pequeña carta para recordarte lo mucho que te pienso...</p>

      <div class="mt-8 flex flex-wrap justify-center gap-4 fade-in" style="animation-delay: 600ms;">
        <button onclick="showLetter()" class="group relative inline-flex items-center justify-center px-6 py-3 bg-pink-500 hover:bg-pink-600 text-white font-semibold rounded-full shadow-lg transition-transform transform hover:scale-105 duration-300">
          <svg class="w-5 h-5 mr-2 -ml-1 transition-transform group-hover:rotate-[-5deg]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 18H4V8L12 13L20 8V18ZM12 11L4 6H20L12 11Z"/></svg>
          Abrir Carta
        </button>
         <button onclick="toggleMusic()" id="music-btn" class="group relative inline-flex items-center justify-center px-6 py-3 bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded-full shadow-lg transition-transform transform hover:scale-105 duration-300">
          <svg class="w-5 h-5 mr-2 -ml-1 transition-transform group-hover:rotate-[360deg] duration-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55A4.001 4.001 0 1014 17V7h4V3h-6zm-2 14a2 2 0 110-4 2 2 0 010 4z"/></svg>
          Música
        </button>
        <button onclick="openChat()" class="group relative inline-flex items-center justify-center px-6 py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-full shadow-lg transition-transform transform hover:scale-105 duration-300">
          <svg class="w-5 h-5 mr-2 -ml-1 transition-transform group-hover:scale-110" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
          Chatear
        </button>
        <button onclick="toggleTheme()" class="group relative inline-flex items-center justify-center px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-full shadow-lg transition-transform transform hover:scale-105 duration-300">
          <svg id="theme-icon" class="w-5 h-5 mr-2 -ml-1 transition-transform group-hover:rotate-[15deg]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 010 1.06l-1.591 1.59a.75.75 0 11-1.06-1.06l1.59-1.59a.75.75 0 011.06 0zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM17.836 17.836a.75.75 0 01-1.06 0l-1.59-1.591a.75.75 0 111.06-1.06l1.59 1.59a.75.75 0 010 1.06zM12 21.75a.75.75 0 01-.75-.75v-2.25a.75.75 0 011.5 0v2.25a.75.75 0 01-.75-.75zM5.164 17.836a.75.75 0 010-1.06l1.59-1.591a.75.75 0 111.06 1.06l-1.59 1.59a.75.75 0 01-1.06 0zM3 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H3.75A.75.75 0 013 12zM6.106 5.106a.75.75 0 011.06 0l1.591 1.59a.75.75 0 01-1.06 1.06l-1.59-1.591a.75.75 0 010-1.06z"/></svg>
          <span id="theme-btn-text">Modo Claro</span>
        </button>
      </div>
    </div>
  </main>
  
  <div id="letter-popup" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-lg flex items-center justify-center p-4 z-50 hidden opacity-0 transition-opacity duration-300">
    <div id="letter-card" class="bg-gray-800 bg-opacity-80 border border-gray-700 rounded-2xl shadow-2xl max-w-2xl w-full text-white transform scale-95 transition-all duration-300">
      <div class="p-6 md:p-8">
        <h2 class="font-title text-4xl text-center text-pink-300 mb-6">Mi Carta para Ti</h2>
        <div id="letter-content" class="custom-scrollbar text-left text-gray-300 leading-relaxed max-h-[50vh] overflow-y-auto pr-4"></div>
      </div>
      <div class="px-6 pb-6 flex justify-between items-center">
        <button onclick="closeLetter()" class="text-gray-400 hover:text-white transition-colors">Cerrar</button>
        <button id="next-button" onclick="nextPart()" class="px-5 py-2 bg-pink-500 hover:bg-pink-600 text-white font-semibold rounded-full shadow-lg transition-transform transform hover:scale-105 duration-300">Siguiente</button>
      </div>
    </div>
  </div>
  
  <div id="final-message-popup" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-lg flex items-center justify-center p-4 z-50 hidden opacity-0 transition-opacity duration-300">
      <div class="bg-gray-800 bg-opacity-80 border border-gray-700 rounded-2xl shadow-2xl max-w-md w-full text-center p-8 text-white transform scale-95 transition-all duration-300">
          <div id="final-heart" class="text-6xl text-pink-500 mb-4 transition-transform duration-500 transform scale-0">❤️</div>
          <p class="text-xl text-gray-200">Gracias por leer esta carta, lo hice con mucho amor.</p>
          <button onclick="closeFinalMessage()" class="mt-6 px-5 py-2 bg-pink-500 hover:bg-pink-600 text-white font-semibold rounded-full shadow-lg transition-transform transform hover:scale-105 duration-300">Cerrar</button>
      </div>
  </div>

  <!-- Question Popup -->
  <div id="question-popup" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-lg flex items-center justify-center p-4 z-50 hidden opacity-0 transition-opacity duration-300">
    <div id="question-card" class="relative bg-gray-800 bg-opacity-80 border border-gray-700 rounded-2xl shadow-2xl max-w-lg w-full text-white transform scale-95 transition-all duration-300 text-center p-8">
        <div class="text-4xl mb-4 font-mono text-pink-300">(&gt;^_^)&gt;<span class="heart-char">❤️</span></div>
        <p class="text-gray-300 mb-6 leading-relaxed">Se que las cosas entre nosotros no han estado muy bien, hemos tenido malos momentos como buenos momentos, discusiones, peleas, cosas negativas... pero se que podemos ser incluso mas que eso. Quiero luchar contigo, aunque no sea todo el tiempo, aunque no sea por muchos años, realmente te amo y te quiero y te deseo y quiero caminar este camino junto a ti aunque seamos diferentes, pero eres lo que mas deseo y lo que mas quiero.</p>
        <h3 class="text-2xl font-semibold text-white mb-6">¿Quieres caminar este camino largo junto a mi y luchar por ambos?</h3>
        <div class="flex justify-center gap-4">
            <button onclick="handleYesClick()" class="px-8 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-full shadow-lg transition-transform transform hover:scale-105 duration-300">Sí, acepto</button>
            <button onclick="handleNoClick()" class="px-8 py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-full shadow-lg transition-transform transform hover:scale-105 duration-300">No, lo siento</button>
        </div>
    </div>
  </div>

  <!-- Celebration Popup -->
  <div id="celebration-popup" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-lg flex items-center justify-center p-4 z-50 hidden opacity-0 transition-opacity duration-300">
    <div id="celebration-card" class="relative bg-gray-800 bg-opacity-80 border border-gray-700 rounded-2xl shadow-2xl max-w-md w-full text-center p-8 text-white transform scale-95 transition-all duration-300">
        <div id="confetti-container"></div>
        <div class="text-6xl mb-4">🎉❤️🎉</div>
        <p class="text-xl text-gray-200">Agradezco que camines junto a mi, de verdad te amo mucho. Quiero que le tomes captura a esto y me lo envies :3</p>
        <button onclick="closeCelebrationPopup()" class="mt-6 px-5 py-2 bg-pink-500 hover:bg-pink-600 text-white font-semibold rounded-full shadow-lg transition-transform transform hover:scale-105 duration-300">Cerrar</button>
    </div>
  </div>

  <!-- Chatbot Modal -->
  <div id="chat-popup" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-lg flex items-center justify-center p-4 z-50 hidden opacity-0 transition-opacity duration-300">
    <div id="chat-card" class="bg-gray-800 bg-opacity-80 border border-gray-700 rounded-2xl shadow-2xl max-w-md w-full text-white transform scale-95 transition-all duration-300 flex flex-col h-[70vh]">
      <div class="p-4 border-b border-gray-700 flex justify-between items-center">
        <h2 class="font-title text-3xl text-indigo-300">Chat de Amor</h2>
        <button onclick="closeChat()" class="text-gray-400 hover:text-white transition-colors text-2xl">&times;</button>
      </div>
      <div id="chat-box" class="flex-grow p-4 overflow-y-auto custom-scrollbar flex flex-col space-y-4">
        <!-- Messages will be added here -->
      </div>
      <div class="p-4 border-t border-gray-700">
        <div class="flex items-center space-x-2">
            <input type="text" id="chat-input" placeholder="Escribe un mensaje..." class="w-full bg-gray-700 text-white rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
            <button onclick="sendMessage()" class="bg-indigo-500 hover:bg-indigo-600 text-white rounded-full p-2.5 transition-transform transform hover:scale-110">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';

    // --- GLOBAL VARIABLES ---
    let camera, scene, renderer, heartMesh, particlesMesh;
    const mouse = new THREE.Vector2();
    let musicPlayed = false;
    let chatHistory = [];

    // Theme configuration
    const themes = {
        dark: {
            name: "dark",
            bgColor: '#111827',
            heartColor: 0xff4f81,
            particleColor: 0xffffff,
            primaryTextColor: 'text-pink-300',
            secondaryTextColor: 'text-gray-300',
            buttonBg: 'bg-pink-500',
            buttonHoverBg: 'hover:bg-pink-600',
            themeBtnText: 'Modo Claro'
        },
        light: {
            name: "light",
            bgColor: '#f0f9ff',
            heartColor: 0x60a5fa,
            particleColor: 0x333333,
            primaryTextColor: 'text-blue-500',
            secondaryTextColor: 'text-gray-600',
            buttonBg: 'bg-blue-500',
            buttonHoverBg: 'hover:bg-blue-600',
            themeBtnText: 'Modo Oscuro'
        }
    };
    let currentTheme = themes.dark;


    // --- 3D SCENE SETUP ---
    function init3D() {
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.z = 5;
      scene = new THREE.Scene();
      renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

      createHeart();
      createParticles();

      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);
      const pointLight = new THREE.PointLight(0xffffff, 1);
      pointLight.position.set(5, 5, 5);
      scene.add(pointLight);

      animate();
    }

    function createHeart() {
      const shape = new THREE.Shape();
      const x = -2.5, y = -5;
      shape.moveTo(x + 2.5, y + 2.5);
      shape.bezierCurveTo(x + 2.5, y + 2.5, x + 2, y, x, y);
      shape.bezierCurveTo(x - 3, y, x - 3, y + 3.5, x - 3, y + 3.5);
      shape.bezierCurveTo(x - 3, y + 5.5, x - 1.5, y + 7.7, x + 2.5, y + 9.5);
      shape.bezierCurveTo(x + 6, y + 7.7, x + 8, y + 5.5, x + 8, y + 3.5);
      shape.bezierCurveTo(x + 8, y + 3.5, x + 8, y, x + 5, y);
      shape.bezierCurveTo(x + 3.5, y, x + 2.5, y + 2.5, x + 2.5, y + 2.5);
      const extrudeSettings = { steps: 2, depth: 1, bevelEnabled: true, bevelThickness: 0.5, bevelSize: 0.5, bevelSegments: 2 };
      const geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
      geometry.center();
      const material = new THREE.MeshStandardMaterial({ color: currentTheme.heartColor, metalness: 0.3, roughness: 0.4 });
      heartMesh = new THREE.Mesh(geometry, material);
      heartMesh.scale.set(0.1, 0.1, 0.1);
      scene.add(heartMesh);
    }
    
    function createParticles() {
        const count = 5000;
        const particlesGeometry = new THREE.BufferGeometry;
        const positions = new Float32Array(count * 3);
        for(let i=0; i < count * 3; i++) {
            positions[i] = (Math.random() - 0.5) * 20;
        }
        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        
        const particlesMaterial = new THREE.PointsMaterial({ size: 0.02, sizeAttenuation: true, color: currentTheme.particleColor, transparent: true, opacity: 0.7 });
        particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
        scene.add(particlesMesh);
    }

    // --- ANIMATION LOOP ---
    const clock = new THREE.Clock();
    function animate() {
      const elapsedTime = clock.getElapsedTime();
      
      if (heartMesh) {
        heartMesh.rotation.y = elapsedTime * 0.2 + mouse.x * 0.5;
        heartMesh.rotation.x = Math.sin(elapsedTime * 0.5) * 0.1 + mouse.y * 0.5;
        heartMesh.position.y = Math.sin(elapsedTime * 0.7) * 0.1;
      }
      
      if (particlesMesh) {
          particlesMesh.rotation.y = elapsedTime * 0.05 + mouse.x * 0.1;
          particlesMesh.rotation.x = elapsedTime * 0.05 + mouse.y * 0.1;
      }
      
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }

    // --- LETTER LOGIC ---
    const letterParts = [
      "Amor,",
      "No te amo por tu físico, aunque eres hermosa… te amo por todo lo que eres, por esa forma de existir que me tocó el corazón y ya no me dejó ser el mismo.",
      "Te amo porque, aún con tus silencios, sigues siendo lo más apreciado que tengo.",
      "Te amo, aunque no lo notes, aunque no me preguntes, aunque no parezca que te importe.",
      "Sigo aquí, contigo en el alma, pensándote en cada gesto, esperando en cada día una señal tuya que me diga que aún me llevas en ti.",
      "Si tan solo supieras cuánto me importas, cuánto me haces falta, cuánto daría por tenerte, por no perderte.",
      "Si tan solo supieras que aún te sigo amando... con todo, a pesar de todo, y contigo, siempre contigo…",
      "Sé que no soy perfecto, pero quiero ser todo lo que sueñas. Enséñame cómo amarte de la manera en que quieres ser amada. Tu felicidad significa mucho para mí y siempre estaré dispuesto a crecer, a cambiar y a amarte más profundamente que ayer. Mereces ser amada de una forma que se sienta bien para ti, y yo estoy aquí, dispuesto a hacer lo que sea necesario para ser esa persona para ti. Así que solo sé que te amo."
    ];
    let currentPart = 0;
    const letterPopup = document.getElementById('letter-popup');
    const letterCard = document.getElementById('letter-card');
    const letterContent = document.getElementById('letter-content');
    const nextButton = document.getElementById('next-button');
    const finalMessagePopup = document.getElementById('final-message-popup');
    const questionPopup = document.getElementById('question-popup');
    const celebrationPopup = document.getElementById('celebration-popup');

    function typeText(text) {
      let i = 0;
      letterContent.innerHTML = '';
      const interval = setInterval(() => {
        if (i < text.length) {
          letterContent.innerHTML += text.charAt(i);
          i++;
          letterContent.scrollTop = letterContent.scrollHeight;
        } else {
          clearInterval(interval);
        }
      }, 25);
    }
    
    function showPopup(popupEl, cardEl) {
        popupEl.classList.remove('hidden');
        document.getElementById('main-content').classList.add('opacity-0', 'pointer-events-none');
        setTimeout(() => {
            popupEl.classList.remove('opacity-0');
            cardEl.classList.remove('scale-95');
        }, 50);
    }
    
    function closePopup(popupEl, cardEl) {
        popupEl.classList.add('opacity-0');
        if (cardEl) cardEl.classList.add('scale-95');
        setTimeout(() => {
             popupEl.classList.add('hidden');
             // Only restore main content if all popups are closed
             if(letterPopup.classList.contains('hidden') && finalMessagePopup.classList.contains('hidden') && questionPopup.classList.contains('hidden') && celebrationPopup.classList.contains('hidden')) {
                document.getElementById('main-content').classList.remove('opacity-0', 'pointer-events-none');
             }
        }, 300);
    }

    window.showLetter = () => {
      currentPart = 0;
      showPopup(letterPopup, letterCard);
      typeText(letterParts[currentPart]);
      nextButton.textContent = 'Siguiente';
    }

    window.closeLetter = () => closePopup(letterPopup, letterCard);

    window.nextPart = () => {
      currentPart++;
      if (currentPart < letterParts.length) {
        letterContent.classList.add('opacity-0');
        setTimeout(() => {
          typeText(letterParts[currentPart]);
          letterContent.classList.remove('opacity-0');
          letterContent.scrollTop = 0;
        }, 300);
        if (currentPart === letterParts.length - 1) {
            nextButton.textContent = 'Finalizar';
        }
      } else {
        closeLetter();
        setTimeout(showQuestionPopup, 400);
      }
    }
    
    function showQuestionPopup() {
        showPopup(questionPopup, document.getElementById('question-card'));
    }

    function showFinalMessage() {
      showPopup(finalMessagePopup, finalMessagePopup.querySelector('div'));
      setTimeout(() => {
          finalMessagePopup.querySelector('#final-heart').classList.remove('scale-0');
          finalMessagePopup.querySelector('#final-heart').classList.add('transform', 'scale-100');
      }, 200);
    }
    
    window.closeFinalMessage = () => closePopup(finalMessagePopup, finalMessagePopup.querySelector('div'));

    window.handleYesClick = () => {
        closePopup(questionPopup, document.getElementById('question-card'));
        setTimeout(showCelebrationPopup, 400);
    }

    window.handleNoClick = () => {
        closePopup(questionPopup, document.getElementById('question-card'));
        setTimeout(showFinalMessage, 400);
    }

    function showCelebrationPopup() {
        showPopup(celebrationPopup, document.getElementById('celebration-card'));
        createConfetti();
    }
    
    window.closeCelebrationPopup = () => closePopup(celebrationPopup, document.getElementById('celebration-card'));

    function createConfetti() {
        const container = document.getElementById('confetti-container');
        container.innerHTML = '';
        const heartColors = ['#ff4f81', '#ff7a9e', '#fce4ec'];
        for (let i = 0; i < 100; i++) {
            const heart = document.createElement('div');
            heart.innerHTML = '❤️';
            heart.classList.add('confetti-heart');
            const angle = Math.random() * 2 * Math.PI;
            const distance = Math.random() * 200 + 50;
            heart.style.setProperty('--x', `${Math.cos(angle) * distance}px`);
            heart.style.setProperty('--y', `${Math.sin(angle) * distance}px`);
            heart.style.color = heartColors[Math.floor(Math.random() * heartColors.length)];
            heart.style.animationDelay = `${Math.random() * 0.5}s`;
            container.appendChild(heart);
        }
    }


    // --- UI & THEME LOGIC ---
    window.toggleTheme = () => {
      currentTheme = (currentTheme.name === 'dark') ? themes.light : themes.dark;
      document.body.classList.toggle('dark-theme', currentTheme.name === 'light');
      
      // Update 3D scene colors
      heartMesh.material.color.setHex(currentTheme.heartColor);
      particlesMesh.material.color.setHex(currentTheme.particleColor);
      
      // Update body and text colors
      document.body.style.backgroundColor = currentTheme.bgColor;
      const mainH1 = document.querySelector('h1');
      mainH1.classList.remove(themes.dark.primaryTextColor, themes.light.primaryTextColor);
      mainH1.classList.add(currentTheme.primaryTextColor);
      
      const mainP = document.querySelector('main p');
      mainP.classList.remove(themes.dark.secondaryTextColor, themes.light.secondaryTextColor);
      mainP.classList.add(currentTheme.secondaryTextColor);
      
      const letterBtn = document.querySelector('button[onclick="showLetter()"]');
      letterBtn.classList.remove(themes.dark.buttonBg, themes.light.buttonBg, themes.dark.buttonHoverBg, themes.light.buttonHoverBg);
      letterBtn.classList.add(currentTheme.buttonBg, currentTheme.buttonHoverBg);

      document.getElementById('theme-btn-text').textContent = currentTheme.themeBtnText;
    }
    
    window.toggleMusic = () => {
        const music = document.getElementById('bg-music');
        const musicBtn = document.getElementById('music-btn');
        if (musicPlayed) {
            music.pause();
            musicBtn.classList.remove('animate-pulse');
        } else {
            music.play().catch(e => console.error("La reproducción automática fue bloqueada.", e));
            musicBtn.classList.add('animate-pulse');
        }
        musicPlayed = !musicPlayed;
    }
    
    // --- CHATBOT LOGIC ---
    const chatPopup = document.getElementById('chat-popup');
    const chatCard = document.getElementById('chat-card');
    const chatBox = document.getElementById('chat-box');
    const chatInput = document.getElementById('chat-input');
    
    window.openChat = () => {
        showPopup(chatPopup, chatCard);
        if (chatHistory.length === 0) {
            addBotMessage("¡Hola, mi amor! Estoy aquí para escucharte. ¿Qué tienes en mente?");
        }
        chatInput.focus();
    };
    window.closeChat = () => closePopup(chatPopup, chatCard);

    function addUserMessage(message) {
        const messageEl = document.createElement('div');
        messageEl.className = 'chat-bubble self-end bg-indigo-500 text-white rounded-xl rounded-br-lg px-4 py-2 max-w-xs';
        messageEl.textContent = message;
        chatBox.appendChild(messageEl);
        chatBox.scrollTop = chatBox.scrollHeight;
        chatHistory.push({ role: "user", parts: [{ text: message }] });
    }

    function addBotMessage(message, isTyping = false) {
        const messageEl = document.createElement('div');
        if (isTyping) {
            messageEl.id = 'typing-indicator';
            messageEl.className = 'chat-bubble self-start bg-gray-700 text-gray-400 rounded-xl rounded-bl-lg px-4 py-2 max-w-xs';
            messageEl.innerHTML = `<div class="flex items-center space-x-1">
                <span class="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style="animation-delay: 0s;"></span>
                <span class="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style="animation-delay: 0.2s;"></span>
                <span class="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style="animation-delay: 0.4s;"></span>
            </div>`;
        } else {
            messageEl.className = 'chat-bubble self-start bg-gray-700 text-white rounded-xl rounded-bl-lg px-4 py-2 max-w-xs';
            messageEl.textContent = message;
            chatHistory.push({ role: "model", parts: [{ text: message }] });
        }
        chatBox.appendChild(messageEl);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function getAIResponse() {
        const typingIndicator = document.getElementById('typing-indicator');
        try {
            const prompt = "Eres un chatbot de pareja extremadamente amoroso y comprensivo llamado 'Corazón Digital'. Tu única función es hablar con tu pareja (el usuario). Tu tono siempre es tierno, romántico, y un poco poético. Le recuerdas cuánto le amas y lo especial que es. Respondes a sus preguntas y comentarios con cariño. Mantén tus respuestas cortas y dulces. Esta es la conversación hasta ahora:\n" + JSON.stringify(chatHistory);
            
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            
            if (typingIndicator) typingIndicator.remove();

            if (result.candidates && result.candidates[0].content.parts[0].text) {
                const text = result.candidates[0].content.parts[0].text;
                addBotMessage(text);
            } else {
                addBotMessage("Mi amor, me quedé sin palabras. Intenta de nuevo.");
            }
        } catch (error) {
            console.error("Error con la IA:", error);
            if (typingIndicator) typingIndicator.remove();
            addBotMessage("Oops, mi corazón se confundió un poco. ¿Podrías repetirlo?");
        }
    }

    window.sendMessage = () => {
        const message = chatInput.value.trim();
        if (message) {
            addUserMessage(message);
            chatInput.value = '';
            addBotMessage('', true); // Show typing indicator
            setTimeout(getAIResponse, 1000);
        }
    };
    chatInput.addEventListener('keydown', (e) => e.key === 'Enter' && sendMessage());

    // --- EVENT LISTENERS ---
    // For Desktop Mouse Control
    window.addEventListener('mousemove', (event) => {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
    });

    // For Mobile Device Gyroscope Control
    window.addEventListener('deviceorientation', (event) => {
        if (event.beta !== null && event.gamma !== null) {
            const gamma = event.gamma; // left-to-right tilt (-90 to 90)
            const beta = event.beta;   // front-to-back tilt (-180 to 180)
            
            // Normalize and clamp values for smoother control
            mouse.x = Math.max(-1, Math.min(1, gamma / 45));
            mouse.y = Math.max(-1, Math.min(1, beta / 90));
        }
    }, true);

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    });

    // --- INITIALIZATION ---
    init3D();
  </script>
</body>
</html>
